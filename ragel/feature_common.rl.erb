%%{
  machine feature_common;

  # Language specific
  FEATURE = <%= i18n['feature'] %> >start_keyword %end_keyword; 
  BACKGROUND = <%= i18n['background'] %> >start_keyword %end_keyword;
  SCENARIO_OUTLINE = <%= i18n['scenario_outline'] %> >start_keyword %end_keyword;
  SCENARIO = <%= i18n['scenario'] %> >start_keyword %end_keyword;
  STEP = (<%= i18n['given'] %> | <%= i18n['when'] %> | <%= i18n['and'] %> | <%= i18n['then'] %> | <%= i18n['but'] %>) >start_keyword %end_keyword;
  EXAMPLES = <%= i18n['examples'] %> >start_keyword %end_keyword;
 
  EOL = ('\r'? '\n') @inc_line_number @last_newline;

  # Terminators
  FeatureHeadingEnd = EOL+ space* (BACKGROUND | SCENARIO | SCENARIO_OUTLINE | '@' | '#');
  ScenarioHeadingEnd = EOL+ space* ( SCENARIO | SCENARIO_OUTLINE | STEP | '@' | '#' );
  BackgroundHeadingEnd = EOL+ space* ( SCENARIO | SCENARIO_OUTLINE | STEP | '@' | '#' );
  ScenarioOutlineHeadingEnd = EOL+ space* ( SCENARIO | STEP | '@' | '#' );
  ExamplesHeadingEnd = EOL+ space* '|';
  StartTable = space* '|';
  EndTable = EOL space* ^('|' | space);
  StartPyString = '"""' >start_pystring space* EOL; 
  EndPyString = '"""';
 
  FeatureHeading = space* FEATURE %begin_content %current_line ^FeatureHeadingEnd* %/store_feature_content :>> FeatureHeadingEnd >backup @store_feature_content;
  BackgroundHeading = space* BACKGROUND %begin_content %current_line ^BackgroundHeadingEnd* %/store_background_content :>> BackgroundHeadingEnd >backup @store_background_content;
  ScenarioHeading = space* SCENARIO %begin_content %current_line ^ScenarioHeadingEnd* %/store_scenario_content :>> ScenarioHeadingEnd >backup @store_scenario_content;
  ScenarioOutlineHeading = space* SCENARIO_OUTLINE %begin_content %current_line ^ScenarioOutlineHeadingEnd* %/store_scenario_outline_content :>> ScenarioOutlineHeadingEnd >backup @store_scenario_outline_content;
  ExamplesHeading = space* EXAMPLES %begin_content %current_line ^ExamplesHeadingEnd* %/store_examples_content :>> ExamplesHeadingEnd >backup @store_examples_content;

  Step = space* STEP %begin_content %current_line ^EOL+ %store_step_content %/store_step_content EOL+;  
  Comment = space* '#' >begin_content ^EOL* %store_comment_content %/store_comment_content EOL+;
  Tag = ( '@' [^@\r\n\t ]+ >begin_content ) %store_tag_content;
  Tags = space* (Tag @current_line space*)+ EOL+;  
  Table = StartTable %begin_content %current_line any+ %/end_table :>> EndTable >backup @end_table;
  PyStringLine = (space* ^EOL+ >start_line %end_line :>> EOL) | (space* EOL >start_line %end_line);
  PyString = space* StartPyString %begin_pystring >current_line PyStringLine* space* :>> EndPyString %store_pystring_content %/store_pystring_content :>> EOL+;
  
  MultilineStep = Step (Table | PyString)?;
  Scenario = ScenarioHeading (Comment | MultilineStep)*;
  Examples = ExamplesHeading Comment* Table;
  ScenarioOutline = ScenarioOutlineHeading Comment* ((MultilineStep+ Examples*) | (MultilineStep*));
  Background = BackgroundHeading (Comment | MultilineStep)*;

  Feature = (Tags | Comment)* FeatureHeading (Tags | Comment)* Background? ((Tags | Comment)* (Scenario | ScenarioOutline))*;

  main := Feature;
}%%
